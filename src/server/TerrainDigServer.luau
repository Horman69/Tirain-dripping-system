--[[
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    –°–ï–†–í–ï–†–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–û–ü–ê–ù–ò–Ø –¢–ï–†–†–ï–ô–ù–ê
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è:
    ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–µ—Ä—Ä–µ–π–Ω—É
    ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏—è —è–º –≤ terrain
    ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö —Å–ª–æ–µ–≤ –±–∏–æ–º–æ–≤
    ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è terrain —á–µ—Ä–µ–∑ Roblox API
    
    –í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ–º FillRegion —Å resolution=1 –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
    ‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 —Å–ª–æ—è –ø–æ–¥ –∏–≥—Ä–æ–∫–æ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏  
    ‚Ä¢ –°–ª—É—á–∞–π–Ω—ã–µ –±–∏–æ–º—ã –∏–∑ BiomeConfig
    ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
    
    –ê–≤—Ç–æ—Ä: Rus_ik000
    –î–∞—Ç–∞: 2025
--]]

local TerrainDigServer = {}

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- –ò–ú–ü–û–†–¢–´ –ò –°–ï–†–í–ò–°–´
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã Roblox
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –∫–æ–Ω—Ñ–∏–≥–∏
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MasterConfig = require(ReplicatedStorage.Shared.MasterConfig)
local RemoteEvents = require(ReplicatedStorage.Shared.RemoteEvents)

-- –°—Å—ã–ª–∫–∞ –Ω–∞ terrain –æ–±—ä–µ–∫—Ç
local terrain = Workspace.Terrain

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- –õ–û–ö–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

-- –ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∫–æ–ø–∞–Ω–∏—è (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º)
local lastDigTimes = {} -- [playerId] = tick()

-- –ö—ç—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤  
local generatedLayers = {} -- [layerIndex] = {biome, timestamp}

-- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∞–º–æ–≥–æ –≥–ª—É–±–æ–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞
local deepestPlayerY = 1000 -- –ù–∞—á–∏–Ω–∞–µ–º —Å –±–æ–ª—å—à–æ–≥–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞
local lastDepthCheck = 0

-- –°—á–µ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å terrain
local activeOperations = 0

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–û–ü–ê–ù–ò–Ø
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

--[[
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫ –∏–≥—Ä–æ–∫–∞ –ø–æ —Ç–µ—Ä—Ä–µ–π–Ω—É –∏ —Å–æ–∑–¥–∞–µ—Ç —è–º—É
    
    @param player Player - –∏–≥—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –∫–ª–∏–∫–Ω—É–ª
    @param hitPosition Vector3 - –ø–æ–∑–∏—Ü–∏—è –∫–ª–∏–∫–∞ –≤ –º–∏—Ä–µ
    @return boolean - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏
--]]
function TerrainDigServer.processDigClick(player, hitPosition)
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
    if not TerrainDigServer.validateDigRequest(player, hitPosition) then
        return false
    end
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–ø–∞–Ω–∏—è
    lastDigTimes[player.UserId] = tick()
    
    -- –°–æ–∑–¥–∞–µ–º —è–º—É –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    local success = TerrainDigServer.createHole(hitPosition)
    
    if success then
        print("TerrainDigServer: –ò–≥—Ä–æ–∫ " .. player.Name .. " —É—Å–ø–µ—à–Ω–æ –≤—ã–∫–æ–ø–∞–ª —è–º—É –≤ –ø–æ–∑–∏—Ü–∏–∏ " .. tostring(hitPosition))
        
        -- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤ –ø–æ—Å–ª–µ –∫–æ–ø–∞–Ω–∏—è
        ensureLayersExist()
        
        -- –ü–æ–ª—É—á–∞–µ–º –±–∏–æ–º —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ—è –¥–ª—è –æ—Ç—á–µ—Ç–∞
        local currentLayerIndex = MasterConfig.getLayerIndex(hitPosition.Y)
        local currentBiome = "–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å"
        
        if currentLayerIndex > 0 then
            currentBiome = generatedLayers[currentLayerIndex] and generatedLayers[currentLayerIndex].biome or "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        end
        
        print("üåç –ò–≥—Ä–æ–∫ –≤ –±–∏–æ–º–µ:", currentBiome, "—Å–ª–æ–π:", currentLayerIndex)
        
        return true
    else
        warn("TerrainDigServer: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —è–º—É –¥–ª—è –∏–≥—Ä–æ–∫–∞ " .. player.Name)
        return false
    end
end

--[[
    –°–æ–∑–¥–∞–µ—Ç —è–º—É (–ø—É—Å—Ç–æ—Ç—É) –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Ç–µ—Ä—Ä–µ–π–Ω–∞
    
    @param position Vector3 - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —è–º—ã
    @return boolean - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è —è–º—ã
--]]
function TerrainDigServer.createHole(position)
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    if activeOperations >= MasterConfig.PERFORMANCE.TERRAIN_OPERATIONS.MAX_CONCURRENT then
        warn("TerrainDigServer: –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å terrain")
        return false
    end
    
    activeOperations = activeOperations + 1
    
    local success = pcall(function()
        local holeConfig = MasterConfig.DIGGING.HOLE_DIMENSIONS
        
        if holeConfig.SHAPE == "sphere" then
            -- üåë –°–§–ï–†–ò–ß–ï–°–ö–ê–Ø –Ø–ú–ê - –∏—Å–ø–æ–ª—å–∑—É–µ–º FillBall –¥–ª—è –∫—Ä—É–≥–ª—ã—Ö —è–º
            local radius = holeConfig.RADIUS
            terrain:FillBall(
                position,
                radius,
                MasterConfig.WORLD.TERRAIN_API.AIR_MATERIAL
            )
            
            -- –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è —Å—Ñ–µ—Ä—ã
            if MasterConfig.TECHNICAL.DEBUG.ENABLE_DEBUG_MODE then
                local sphereSize = Vector3.new(radius * 2, radius * 2, radius * 2)
                TerrainDigServer.createDebugMarker(
                    position, 
                    sphereSize, 
                    MasterConfig.TECHNICAL.DEBUG.VISUAL_MARKERS.COLORS.HOLE,
                    "SPHERE_HOLE"
                )
            end
            
        else
            -- üü¶ –ö–£–ë–ò–ß–ï–°–ö–ê–Ø –Ø–ú–ê - –∏—Å–ø–æ–ª—å–∑—É–µ–º FillRegion –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —è–º
            local holeSize = MasterConfig.getHoleSizeVector()
            local region = MasterConfig.createRegion(position, holeSize)
            
            terrain:FillRegion(
                region, 
                MasterConfig.WORLD.TERRAIN_API.RESOLUTION, 
                MasterConfig.WORLD.TERRAIN_API.AIR_MATERIAL
            )
            
            -- –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –∫—É–±–∞
            if MasterConfig.TECHNICAL.DEBUG.ENABLE_DEBUG_MODE then
                TerrainDigServer.createDebugMarker(
                    position, 
                    holeSize, 
                    MasterConfig.TECHNICAL.DEBUG.VISUAL_MARKERS.COLORS.HOLE,
                    "CUBE_HOLE"
                )
            end
        end
    end)
    
    activeOperations = activeOperations - 1
    
    if not success then
        warn("TerrainDigServer: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —è–º—ã –≤ –ø–æ–∑–∏—Ü–∏–∏ " .. tostring(position))
    end
    
    return success
end

-- –§—É–Ω–∫—Ü–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∞–º–æ–≥–æ –≥–ª—É–±–æ–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞
function updateDeepestPlayer()
    local currentTime = tick()
    if currentTime - lastDepthCheck < 2 then return end -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
    
    lastDepthCheck = currentTime
    local newDeepest = 1000 -- –ù–∞—á–∏–Ω–∞–µ–º —Å –±–æ–ª—å—à–æ–≥–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞
    
    -- –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local playerY = player.Character.HumanoidRootPart.Position.Y
            if playerY < newDeepest then
                newDeepest = playerY
            end
        end
    end
    
    -- –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—à–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ –ø–æ–∑–∏—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–ª—É–±–∂–µ
    if newDeepest < 1000 and newDeepest < deepestPlayerY then
        deepestPlayerY = newDeepest
        print("üîÑ –°–∞–º—ã–π –≥–ª—É–±–æ–∫–∏–π –∏–≥—Ä–æ–∫ –Ω–∞ Y:", deepestPlayerY)
    end
end

-- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
function generateHorizontalLayer(layerIndex)
    if generatedLayers[layerIndex] then
        return -- –°–ª–æ–π —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
    end
    
    -- –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –±–∏–æ–º
    local biome = MasterConfig.getRandomUndergroundBiome()
    local layerY = MasterConfig.getLayerY(layerIndex)
    
    -- –°–æ–∑–¥–∞–µ–º —Ä–µ–≥–∏–æ–Ω –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ª–æ—è
    local region = MasterConfig.createHorizontalLayerRegion(layerIndex)
    
    -- –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ª–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º –±–∏–æ–º–∞
    workspace.Terrain:FillRegion(region, 4, biome.material)
    
    -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    generatedLayers[layerIndex] = {
        biome = biome.name,
        timestamp = tick(),
        y = layerY
    }
    
    print("üèóÔ∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ª–æ–π", layerIndex, "–±–∏–æ–º:", biome.name, "Y:", layerY)
end

-- –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω—ã—Ö —Å–ª–æ–µ–≤
function ensureLayersExist()
    updateDeepestPlayer()
    
    -- –í—ã—á–∏—Å–ª—è–µ–º –∫–∞–∫–∏–µ —Å–ª–æ–∏ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
    local bufferDepth = MasterConfig.WORLD.LAYER_SYSTEM.PREVIEW_DISTANCE
    local deepestLayerNeeded = MasterConfig.getLayerIndex(deepestPlayerY - bufferDepth)
    
    -- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Å–µ —Å–ª–æ–∏ –æ—Ç 1 –¥–æ –Ω—É–∂–Ω–æ–≥–æ
    for layerIndex = 1, deepestLayerNeeded do
        generateHorizontalLayer(layerIndex)
    end
end

--[[
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Å–ª–æ–∏ –±–∏–æ–º–æ–≤ –ø–æ–¥ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–µ–π
    –£–°–¢–ê–†–ï–í–®–ê–Ø –§–£–ù–ö–¶–ò–Ø - –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏
    
    @param abovePosition Vector3 - –ø–æ–∑–∏—Ü–∏—è –Ω–∞–¥ –∫–æ—Ç–æ—Ä–æ–π –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∏
    @param playerId number - ID –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
--]]
function TerrainDigServer.generateLayersBelow(abovePosition, playerId)
    -- –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ –≤–º–µ—Å—Ç–æ —Ç–æ—á–µ—á–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    ensureLayersExist()
    
    -- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ—è—Ö –≤ —Ç–µ–∫—É—â–µ–π –æ–±–ª–∞—Å—Ç–∏
    local layerIndex = MasterConfig.getLayerIndex(abovePosition.Y)
    return generatedLayers[layerIndex] and generatedLayers[layerIndex].biome or "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
end

--[[
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–∏–Ω —Å–ª–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –±–∏–æ–º–∞
    
    @param centerPosition Vector3 - —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —Å–ª–æ—è
    @param biome table - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–∏–æ–º–∞ –∏–∑ BiomeConfig
    @param playerId number - ID –∏–≥—Ä–æ–∫–∞  
    @param layerIndex number - –∏–Ω–¥–µ–∫—Å —Å–ª–æ—è
--]]
function TerrainDigServer.generateLayer(centerPosition, biome, playerId, layerIndex)
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
    if activeOperations >= MasterConfig.PERFORMANCE.TERRAIN_OPERATIONS.MAX_CONCURRENT then
        warn("TerrainDigServer: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–ª–æ—è –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π")
        return
    end
    
    activeOperations = activeOperations + 1
    
    local success = pcall(function()
        -- –°–æ–∑–¥–∞–µ–º Region3 –¥–ª—è —Å–ª–æ—è
        local layerSize = MasterConfig.getGenerationAreaVector()
        local region = MasterConfig.createRegion(centerPosition, layerSize)
        
        -- –ó–∞–ø–æ–ª–Ω—è–µ–º —Ä–µ–≥–∏–æ–Ω –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º –±–∏–æ–º–∞
        terrain:FillRegion(
            region,
            MasterConfig.WORLD.TERRAIN_API.RESOLUTION,
            biome.material
        )
        
        -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ª–æ–µ –≤ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ (—Å–µ–π—á–∞—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        -- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ generatedLayers
        
        -- –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        if MasterConfig.TECHNICAL.DEBUG.ENABLE_DEBUG_MODE then
            TerrainDigServer.createDebugMarker(
                centerPosition,
                layerSize,
                MasterConfig.TECHNICAL.DEBUG.VISUAL_MARKERS.COLORS.LAYER,
                "LAYER_" .. biome.displayName
            )
        end
        
        print("TerrainDigServer: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª–æ–π " .. biome.displayName .. " –≤ –ø–æ–∑–∏—Ü–∏–∏ " .. tostring(centerPosition))
    end)
    
    activeOperations = activeOperations - 1
    
    if not success then
        warn("TerrainDigServer: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ—è " .. biome.displayName)
    end
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

--[[
    –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–ø–∞–Ω–∏–µ –æ—Ç –∏–≥—Ä–æ–∫–∞
    
    @param player Player - –∏–≥—Ä–æ–∫
    @param position Vector3 - –ø–æ–∑–∏—Ü–∏—è –∫–æ–ø–∞–Ω–∏—è
    @return boolean - –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞
--]]
function TerrainDigServer.validateDigRequest(player, position)
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if not player or not player.Character then
        warn("TerrainDigServer: –ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞—Å–ø–∞–≤–Ω–µ–Ω")
        return false
    end
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—É–ª–¥–∞—É–Ω –∫–æ–ø–∞–Ω–∏—è
    local lastDigTime = lastDigTimes[player.UserId] or 0
    if tick() - lastDigTime < MasterConfig.DIGGING.LIMITS.COOLDOWN_TIME then
        warn("TerrainDigServer: –ò–≥—Ä–æ–∫ " .. player.Name .. " –∫–æ–ø–∞–µ—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ")
        return false
    end
    
    -- –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
    local playerPosition = player.Character.HumanoidRootPart.Position
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–æ–ø–∞–Ω–∏—è
    local isValid, reason = MasterConfig.isValidDigPosition(position, playerPosition)
    if not isValid then
        warn("TerrainDigServer: –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –∫–æ–ø–∞–Ω–∏—è: " .. reason)
        return false
    end
    
    return true
end

--[[
    –°–æ–∑–¥–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä (—Ç–æ–ª—å–∫–æ –≤ DEBUG_MODE)
    
    @param position Vector3 - –ø–æ–∑–∏—Ü–∏—è –º–∞—Ä–∫–µ—Ä–∞
    @param size Vector3 - —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞  
    @param color Color3 - —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞
    @param label string - —Ç–µ–∫—Å—Ç–æ–≤–∞—è –º–µ—Ç–∫–∞
--]]
function TerrainDigServer.createDebugMarker(position, size, color, label)
    if not MasterConfig.TECHNICAL.DEBUG.ENABLE_DEBUG_MODE then
        return
    end
    
    -- –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—É—é —á–∞—Å—Ç—å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    local marker = Instance.new("Part")
    marker.Name = "DebugMarker_" .. label
    marker.Size = size
    marker.Position = position
    marker.Material = Enum.Material.ForceField
    marker.Color = color
    marker.Transparency = 0.7
    marker.Anchored = true
    marker.CanCollide = false
    marker.Parent = Workspace
    
    -- –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –º–µ—Ç–∫—É
    local gui = Instance.new("BillboardGui")
    gui.Size = UDim2.new(0, 100, 0, 50)
    gui.Parent = marker
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.Text = label
    textLabel.TextColor3 = Color3.new(1, 1, 1)
    textLabel.BackgroundTransparency = 1
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextScaled = true
    textLabel.Parent = gui
    
    -- –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    game:GetService("Debris"):AddItem(marker, MasterConfig.TECHNICAL.DEBUG.VISUAL_MARKERS.MARKER_LIFETIME)
end

--[[
    –û—á–∏—â–∞–µ—Ç –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–∫–ª—é—á–∏–≤—à–µ–≥–æ—Å—è –∏–≥—Ä–æ–∫–∞
    
    @param player Player - –∏–≥—Ä–æ–∫ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É
--]]
function TerrainDigServer.cleanupPlayerData(player)
    lastDigTimes[player.UserId] = nil
    -- –ö—ç—à –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤ –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –ø–æ—ç—Ç–æ–º—É –Ω–µ —á–∏—Å—Ç–∏–º
    print("TerrainDigServer: –û—á–∏—â–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–≥—Ä–æ–∫–∞ " .. player.Name)
end

-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –û–¢–õ–ê–î–ö–ê
-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

--[[
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∫–æ–ø–∞–Ω–∏—è —Ç–µ—Ä—Ä–µ–π–Ω–∞
--]]
function TerrainDigServer.initialize()
    print("TerrainDigServer: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–æ–ø–∞–Ω–∏—è...")
    
    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å terrain
    if not terrain then
        error("TerrainDigServer: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ Workspace.Terrain!")
    end
    
    -- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º RemoteEvents
    RemoteEvents.initialize()
    
    -- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –∫–æ–ø–∞–Ω–∏—è
    local digEvent = RemoteEvents.getDigTerrainEvent()
    digEvent.OnServerEvent:Connect(function(player, hitPosition)
        -- –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        if not RemoteEvents.validateDigData(player, hitPosition) then
            return
        end
        
        -- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–ø–∞–Ω–∏–µ
        local success = TerrainDigServer.processDigClick(player, hitPosition)
        
        -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∏–µ–Ω—Ç—É
        local resultEvent = RemoteEvents.getDigResultEvent()
        RemoteEvents.safeFireClient(resultEvent, player, {
            success = success,
            position = hitPosition,
            timestamp = tick()
        })
    end)
    
    -- –í—ã–≤–æ–¥–∏–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ñ–∏–≥–∞—Ö
    if MasterConfig.TECHNICAL.DEBUG.ENABLE_DEBUG_MODE then
        MasterConfig.printFullConfiguration()
        RemoteEvents.printDebugInfo()
    end
    
    -- –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    Players.PlayerRemoving:Connect(function(player)
        TerrainDigServer.cleanupPlayerData(player)
    end)
    
    -- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤
    print("TerrainDigServer: –°–∏—Å—Ç–µ–º–∞ –∫–æ–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!")
    
    -- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–µ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    wait(1) -- –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
    ensureLayersExist()
    print("TerrainDigServer: –ù–∞—á–∞–ª—å–Ω—ã–µ —Å–ª–æ–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!")
end

--[[
    –í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã –∫–æ–ø–∞–Ω–∏—è
--]]
function TerrainDigServer.printStats()
    print("‚ïê‚ïê‚ïê –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ö–û–ü–ê–ù–ò–Ø ‚ïê‚ïê‚ïê")
    print("–ê–∫—Ç–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å terrain:", activeOperations)
    print("–ò–≥—Ä–æ–∫–æ–≤ –≤ –∫—ç—à–µ:", table.getn(lastDigTimes or {}))
    print("üîß –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:", #generatedLayers)
    print("‚è∞ –°–∞–º—ã–π –≥–ª—É–±–æ–∫–∏–π –∏–≥—Ä–æ–∫ –Ω–∞ Y:", deepestPlayerY)
    
    for layerIndex, layerData in pairs(generatedLayers) do
        print("  –°–ª–æ–π", layerIndex, ":", layerData.biome, "–Ω–∞ Y:", layerData.y)
    end
    print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
end

-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–æ–¥—É–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö
return TerrainDigServer
